<!DOCTYPE html>

<html>

<head>
    <title>RaceAI</title>
</head>

<body>
    <div>
        <div>
            <div>
                <input type="checkbox" id="debug" name="settings" value="debug" />
                <label for="debug">debug</label>
            </div>

            <div>
                <input type="checkbox" id="ai" name="ai" value="ai" />
                <label for="ai">ai</label>
            </div>
          </div>
        <br/>
        <canvas id="canvas" width="1000" height="1000"></canvas>
    </div>

    <script type="module">
        "use strict";
        import { WebGame } from "./webGame.js";
        import { ModelGame } from "./modelGame.js";
        import { Debug } from "./debug.js";
        import { track_waypoints } from "./track.js";

        let canvas;
        let context;
        let oldTimeStamp = Date.now();
        let game;
        let debugMode = false;
        let debug;
        let reward;
        let track_name = "simple";

        window.onload = init;

        document.getElementById("debug").addEventListener("change", (event) => {
            debugMode = event.target.checked;
        });

        document.getElementById("ai").addEventListener("change", (event) => {
            if (event.target.checked) {
                game = new ModelGame(track_name);
            } else {
                game = new WebGame(track_name);
            }

            debug = new Debug(game);
            reward = 0;
        });

        function init() {
            canvas = document.getElementById('canvas');
            context = canvas.getContext('2d');
            game = new WebGame(track_name);

            debug = new Debug(game);

            reward = 0;

            window.requestAnimationFrame(gameLoop);
        }

        function gameLoop(timeStamp) {
            const deltaTime = (timeStamp - oldTimeStamp) / 1000;
            oldTimeStamp = timeStamp;

            const fps = Math.round(1 / deltaTime);
            context.clearRect(0, 0, canvas.width, canvas.height);

            game.update(deltaTime);
            game.draw(context);

            reward += debug.modelInputs[0].reward();

            if (debugMode) {
                debug.draw(context);

                context.font = '25px Arial';
                context.fillStyle = 'black';
                context.fillText("FPS: " + fps + " LAPS: " + game.player.laps + " Reward: " + reward, 10, 30);
            }

            window.requestAnimationFrame(gameLoop);
        }
    </script>
</body>

</html>
